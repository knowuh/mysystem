// TODO This is for debugging. REMOVE it later.


(function() {
    var util = YAHOO.util;
    var lang = YAHOO.lang;
    var Event = util.Event;
    var Dom = util.Dom;
    var Connect = util.Connect;
    var JSON = lang.JSON;
    var widget = YAHOO.widget;

    /**
   * Proxy to handle the drag/dropping from the module list to the layer
   * @class MySystemDragAndDropProxy
   * @constructor
   * @param {HTMLElement} el
   * @param {MySystemEditor} WiringEditor
   */
    MySystemDragAndDropProxy = function(el, MySysEditor) {
        this._MySysEditor = MySysEditor;
        // Init the DDProxy
        MySystemDragAndDropProxy.superclass.constructor.call(this, el, "module", {
            dragElId: "moduleProxy"
        });
        this.isTarget = false;
    };

    YAHOO.extend(MySystemDragAndDropProxy, YAHOO.util.DDProxy, {

        /**
        * copy the html and apply selected classes
        * @method startDrag
        */
        startDrag: function(e) {
            MySystemDragAndDropProxy.superclass.startDrag.call(this, e);
            var del = this.getDragEl();
            var lel = this.getEl();
            del.innerHTML = lel.innerHTML;
            del.className = lel.className;
        },

        /**
        * Override default behavior of DDProxy
        * @method endDrag
        */
        endDrag: function(e) {},

        /**
        * Add the module to the WiringEditor on drop on layer
        * @method onDragDrop
        */
        onDragDrop: function(e, ddTargets) {

            // The layer is the only target :
            var layerTarget = ddTargets[0];
            var layer = ddTargets[0]._layer;
            var del = this.getDragEl();
            var pos = YAHOO.util.Dom.getXY(del);
            var layerPos = YAHOO.util.Dom.getXY(layer.el);
            pos[0] = pos[0] - layerPos[0];
            pos[1] = pos[1] - layerPos[1];
            this._MySysEditor.addModule(this._module, pos);
            
            console.log( this );
            
            // Compile various energies into one object ( not really using multiple energies per object yet )
            var energyForm = {};
            energyForm[ this._module.fields.form ] = this._module.fields.efficiency;
            
            // Creates a new node in myEngine and stored it in element
            this._module.engineNode = my.newNode({
            		name				: this._module.name,
								module			: this._module,
            		type				: this._module.etype,
            		energy			: this._module.fields.energy || 0,
            		inputRate		: this._module.fields.inputRate,
            		efficiency	: energyForm // reference energies object
            });
            
        }
    });

/**
 * The MySystemEditor class provides a full page interface 
 * @class WiringEditor
 * @constructor
 * @param {Object} options
 */
    MySystemEditor = function(data) {
        // set the default options
        this.setOptions(data);
        this._data = data;
        this.numLayers = 1;
        this.propEditor = new MySystemPropEditor({});
        
        /**
        * Container DOM element
        * @property el
        */
        this.el = Dom.get(data.parentEl);

      /**
       * @property helpPanel
       * @type {YAHOO.widget.Panel}
       */
        this.helpPanel = new widget.Panel('helpPanel', {
            fixedcenter: true,
            draggable: true,
            visible: false,
            modal: true
        });
        this.helpPanel.render();

        /**
       * @property layout
       * @type {YAHOO.widget.Layout}
       */
        this.layout = new widget.Layout(this.el, this.options.layoutOptions);
        this.layout.render();
        
        // Render module list
        this.buildModulesList();

        // Render buttons
        this.renderButtons();
    };

    MySystemEditor.prototype = {
        /**
        * @method setOptions
        * @param {Object} options
        */
        setOptions: function(options) {
            // Unload any older options:
            this.options = {};
            // Load the modules from options
            this.modules = options.modules || ([]);
            this.modulesByName = {};
            for (var i = 0; i < this.modules.length; i++) {
                var m = this.modules[i];
                this.modulesByName[m.name] = m;
            }

            this.options.languageName = options.languageName || 'anonymousLanguage';
            this.options.smdUrl = options.smdUrl || 'WiringEditor.smd'; // eh?
            
            // FIXME: This url should be determined by whatever outside authoring system is wrapping the editor
            this.options.dataDir = "/models";
            this.options.propertiesFields = options.propertiesFields;
            this.options.layoutOptions = options.layoutOptions || {
                units: [
                {
                    position: 'top',
                    height: 50,
                    body: 'top'
                },
                {
                    position: 'left',
                    width: 225,
                    resize: true,
                    body: 'left',
                    gutter: '5px',
                    collapse: true,
                    collapseSize: 25,
                    header: 'Objects and Labels',
                    scroll: true,
                    animate: true
                },
                {
                    position: 'center',
                    body: 'center',
                    gutter: '5px'
                },
                {
                    position: 'right',
                    width: 320,
                    resize: true,
                    body: 'right',
                    gutter: '5px',
                    collapse: true,
                    collapseSize: 25,
                    header: 'Properties',
                    scroll: true,
                    animate: true
                }
                ]
            };
            
            // LAYER OPTION DEFAULTS:
            this.options.layerOptions = {};
            var layerOptions = options.layerOptions || {};
            this.options.layerOptions.parentEl = layerOptions.parentEl ? layerOptions.parentEl: Dom.get('center');
            this.options.layerOptions.layerMap = YAHOO.lang.isUndefined(layerOptions.layerMap) ? true: layerOptions.layerMap;
            this.options.layerOptions.layerMapOptions = layerOptions.layerMapOptions || { parentEl: 'layerMap' };
            
            MySystemContainer.openPropEditorFor.subscribe(this.onOpenPropEditorFor,this,true);
            MySystemContainer.openContextFor.subscribe(this.onOpenContextFor,this,true);
            WireIt.Wire.openPropEditorFor.subscribe(this.onOpenPropEditorFor,this,true);
            // create new layer-map.
            this.resetLayers();
        },

        resetLayers: function() {
          if (this.layerStack && this.layerStack.size > 0) {
            for(var i = 0; i < this.layerStack.size();i++) {
              this.removeLayer(this.layerStack[i]);
            }
          }
          if (this.layer) {
            this.removeLayer(this.layer);
          }
          
          if (this.rootLayer) {
            this.removeLayer(this.rootLayer);
          }
          this.numLayers = 0;
          this.layerStack = [];
          this.rootLayer = this.addLayer();
          this.changeLayer(this.rootLayer);
         },
         
        /**
        * Open the properties editor for this container
        *
        **/
        onOpenPropEditorFor: function(type,args) {
          module = args[0];
          this.propEditor.show(module);
        },
        
        /**
        * Open a new layer for this container
        *
        **/
        onOpenContextFor: function(type,args) {
            module = args[0];
            if (module.has_sub) {
              if (module.subSystem == null) {
                module.subSystem = this.addLayer();
              }
              this.changeLayer(module.subSystem);
            }
        },

        removeLayerMap: function(newLayer) {
          try {
            Event.removeListener(newLayer.layerMap.element, 'mouseup');
            newLayer.layerMap.options.parentEl.removeChild(newLayer.layerMap.element);
            if (this.layerStack.indexOf(newLayer)) {
              this.layerStack[this.layerStack.indexOf(newLayer)]= null;
            }
          }
          catch (e) {
            debug("error removing layer: " + e);
          }
        },
        
        removeLayer: function(newLayer) {
          this.numLayers = this.numLayers - 1;
          this.removeLayerMap(newLayer);
          newLayer.removeAllContainers();
          newLayer = null;
          return null;
        },

        addLayerMap: function(newLayer) {
          this.layerStack.push(newLayer);
          newLayer.layerMap.options.parentEl.appendChild(newLayer.layerMap.element);
          // add listener to layer.layerMap                    
          Event.addListener(newLayer.layerMap.element, 'mouseup', function (e,args) {
             Event.stopEvent(e);
             this.changeLayer(newLayer);
          }, this, true);
        },
        
      addLayer: function() {
          this.numLayers = this.numLayers + 1;
          var newOpts = Object.clone(this.options.layerOptions);
          newOpts.layerNumber = this.numLayers;
          var newLayer = new WireIt.Layer(newOpts);
          this.addLayerMap(newLayer);
          return newLayer;
        },
        
        changeLayer: function(newLayer) {
          var index = this.layerStack.indexOf(newLayer);
          if(index < 0) {
            this.addLayerMap(newLayer);
          }
          // otherwise we remove all the layers under this one (search the tree?)
          else {
            for(var i = index+1; i < this.layerStack.size();i++) {
              this.removeLayerMap(this.layerStack[i]);
            }              
            // after we have deleted things, we compact it:
            this.layerStack = this.layerStack.compact();
          }
          this.setLayer(newLayer)
          this.updateLayerInfo();
        },
        
        setLayer:function(newLayer) {
          // kind of a hack, clean any bad wiring from the layer before we continue:
          this.cleanWiring(newLayer);
          if (this.layer == null) { this.layer = this.rootLayer;}
      	  var parentDom = this.layer.options.parentEl;
          parentDom.replaceChild(newLayer.el,this.layer.el);
          this.layer.el.hide();
          
          //this.layer.el.update(this.layer.options.layerNumber);//whats that going to do?
          this.layer = newLayer;
          this.layer.el.show();
          this.setDDLayer(this.layer);   
          this.hidePropEditor();
        },
        cleanWiring: function(newLayer) {
          var i = 0;
          var size = newLayer.wires.length;
          var wire = null;
          var removed = 0;
          for (i=0; i <size; i++) {
            wire = newLayer.wires[i];
            if((!(wire.terminal1)) ||!(wire.terminal2)) {
              newLayer.wires[i] = null;
              removed +=1;
            }
          }
          if (removed > 0) {
            debug("removed " + removed + " wires");
            debug("array size pre: " + size);
            // WireIt.compact(newLayer.wires);
            newLayer.wires = newLayer.wires.compact();
            debug("array size post: " + newLayer.wires.length);
          }
        },
        
        updateLayerInfo: function() {
          // var layerInfo = "<h3>current layer: " + this.layer.options.layerNumber +"</h3><ul>layer stack:";
          // $A(this.layerStack).each( function(layer){
          //   layerInfo += "<li>" + layer.options.layerNumber + "</li>";
          // });
          // layerInfo += "</li>";
          // $('layer_info').update(layerInfo);
        },
        
        hidePropEditor: function() {
          $('prop_form').hide();
        },
        
        /**
        *
        *
        **/
        setDDLayer: function(theLayer) {
            this.ddTarget = new YAHOO.util.DDTarget(this.layer.el, "module");
            this.ddTarget._layer = this.layer;
        },
        
        addModuleChoice: function(module) {        		
        		
            // debug("found name: " + module.name);
            var left = Dom.get('left');
            var div = WireIt.cn('div', {
                className: "WiringEditor-module"
            });

            if (module.icon) {
                var div = WireIt.cn('div', {
                    className: "WiringEditor-icon-module"
                });
                div.appendChild(WireIt.cn('img', {
                    src: module.icon
                }));
                // debug("created icon module");
            } else {
                var div = WireIt.cn('div', {
                    className: "WiringEditor-module"
                });
                div.appendChild(WireIt.cn('span', null, null, module.name));
                // debug("created WiringEditor module");
            }

            var ddProxy = new MySystemDragAndDropProxy(div, this);
            ddProxy._module = module;
            left.appendChild(div);

            // Make the layer a drag drop target
            this.setDDLayer(this.layer);
        },


        /**
        * Build the left menu on the left
        * @method buildModulesList
        */
        buildModulesList: function() {
            var modules = this.modules;
            for (var i = 0; i < modules.length; i++) {
                var module = modules[i];
                this.addModuleChoice(module);
            }
        },


        /**
        * add a module at the given pos
        * usually invoked by drag-and-drop callback
        */
        addModule: function(module, pos) {        
            try {
                //var containerConfig = module.container;
                // debug("addModule called for " + module.name);
                module.position = pos;
                module.title = module.name;
                module.layer = this.layer;
                var container = this.layer.addContainer(module);
                container.setTitle(module.title);
                container.options.position = pos;
                container.module = module;
                //container.engineNodeId = container.module.engineNode.id;
                Dom.addClass(container.el, "WiringEditor-module-" + module.name);
            }
            catch(ex) {
                // debug("Error Layer.addContainer", ex.message);
            }
        },


        /**
        * Toolbar
        * @method renderButtons
        */
        renderButtons: function() {
            var toolbar = Dom.get('toolbar');
            // Buttons :
            var newButton = new widget.Button({
                label: "Clear Diagram",
                id: "WiringEditor-newButton",
                container: toolbar
            });
            newButton.on("click", this.onNew, this, true);

            var loadButton = new widget.Button({
                label: "Load",
                id: "WiringEditor-loadButton",
                container: toolbar
            });
            loadButton.on("click", this.onLoad, this, true);

            var saveButton = new widget.Button({
                label: "Save",
                id: "WiringEditor-saveButton",
                container: toolbar
            });
            saveButton.on("click", this.onSave, this, true);

            var helpButton = new widget.Button({
                label: "More Info",
                id: "WiringEditor-helpButton",
                container: toolbar
            });
            helpButton.on("click", this.onHelp, this, true);
        },


        onSMDsuccess: function() { alert("Save successful."); },
        onSMDfailure: function() { alert("Save failed."); },

        /**
        * @method onSave
        */
        onSave: function() {
         // debug("Save clicked");
          this.save();
        },

        /**
        * save the layer data
        * @method save
        * TODO: Actually save something!
        */
        save: function() {
        // 	debug([this.rootLayer.getWiring()].toJSON());
        	
        	var postUrl = this.options.dataDir;
        	if (this.options.modelId != null) {
        		postUrl += "/" + this.options.modelId;
        	}

        	var xmlhttp = HTTP.newRequest();
        	xmlhttp.open('PUT', postUrl, false);
        	
        	var json = [this.rootLayer.getWiring()].toJSON();
        	debug("===================================\n" + json);
        	xmlhttp.send([this.rootLayer.getWiring()].toJSON());
        	
        	if (this.options.modelId == null) {
            this.options.modelId  = eval(xmlhttp.responseText);
        	}
        	alert("Your model was saved with the ID: " + this.options.modelId);
        },
        
        /**
         * @method onSave
         */
         onLoad: function() {
         	// debug("Load clicked");
             this.load();
         },
         
         load: function(modelId) {
        	// debug("loading...\nrootLayer: " + this.rootLayer);
        	
         	var callback = function(text, context) {
         	 debug("===================================\n" + text);
	         	var obj = eval(text);
	         	// debug("got object: " + obj[0].containers[0]);
	         	context.resetLayers();
	         	context.rootLayer.setWiring(obj[0]);
	         	// debug("done loading.");
         	};
         	if (modelId) {}
         	else {
         	  this.options.modelId = prompt("Enter the model ID for the model you wish to load: ", this.options.modelId);
         	}
         	HTTP.getText(this.options.dataDir + "/" + this.options.modelId, this, callback);
         },

        /**
        * Create a help panel
        * @method onHelp
        */
        onHelp: function() {
            this.helpPanel.show();
        },

        /**
        * @method onNew
        */
        onNew: function() {
            if (confirm("Are you sure you want to erase your diagram and start fresh?")) {
                this.layer.removeAllContainers();
                this.resetLayers();
            }
        },

        /**
        * @method onDelete
        */
        onDelete: function() {
            if (confirm("Are you sure you want to delete this wiring??")) {
                var value = this.getValue();
                this.service.deleteWiring({
                    name: value.name,
                    language: this.options.languageName
                },
                {
                    success: function(result) {
                        alert("Deleted !");
                    }
                });
            }
        },

        /**
        * This method return a wiring within the given vocabulary described by the modules list
        * @method getValue
        */
        getValue: function() {
            var i;
            var obj = {
                modules: [],
                wires: [],
                properties: null
            };

            for (i = 0; i < this.layer.containers.length; i++) {
                obj.modules.push({
                    name: this.layer.containers[i].options.title,
                    value: this.layer.containers[i].getValue(),
                    config: this.layer.containers[i].getConfig()
                });
            }

            for (i = 0; i < this.layer.wires.length; i++) {
                var wire = this.layer.wires[i];
                var wireObj = {
                    src: {
                        moduleId: WireIt.indexOf(wire.terminal1.container, this.layer.containers),
                        terminal: wire.terminal1.options.name
                    },
                    tgt: {
                        moduleId: WireIt.indexOf(wire.terminal2.container, this.layer.containers),
                        terminal: wire.terminal2.options.name
                    }
                };
                obj.wires.push(wireObj);
            }

            obj.properties = this.propertiesForm.getValue();

            return {
                name: obj.properties.name,
                working: obj
            };
        }

    };

})();
